// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "sqlite"
  url       = env("DATABASE_URL")
}

// 社員マスタ
model User {
  id                String   @id @default(cuid())
  name              String
  username          String   @unique  // ログイン用ユーザー名
  password          String            // ハッシュ化されたパスワード
  position          String?           // 役職(社長、専務、常務、部長など)
  role              String   @default("user") // ユーザー権限 (admin/user)
  defaultReportType String   @default("work") // デフォルト日報タイプ (sales: 営業日報, work: 作業日報)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  dailyReports DailyReport[]
  approvals    Approval[]
}

// 日報
model DailyReport {
  id            String   @id @default(cuid())
  date          DateTime // 日報の日付
  userId        String   // 作成者
  user          User     @relation(fields: [userId], references: [id])
  specialNotes  String?  // 特記事項
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  visitRecords  VisitRecord[]
  approvals     Approval[]
}

// 訪問記録
model VisitRecord {
  id              String   @id @default(cuid())
  dailyReportId   String
  dailyReport     DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  destination     String   // 訪問先
  contactPerson   String?  // 面接者ご氏名
  startTime       String?  // 開始時刻 (HH:MM)
  endTime         String?  // 終了時刻 (HH:MM)
  content         String?  // 営業内容
  expense         Int?     // 支出経費
  order           Int      // 表示順序
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 承認
model Approval {
  id              String   @id @default(cuid())
  dailyReportId   String
  dailyReport     DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  approverRole    String   // 社長、専務、常務、部長
  approverUserId  String?  // 承認者
  approver        User?    @relation(fields: [approverUserId], references: [id])
  approvedAt      DateTime?
  status          String   @default("pending") // pending, approved, rejected
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 物件（現場）マスタ
model Project {
  id          String   @id @default(cuid())
  name        String   // 工事名
  projectType String?  // 工事種別
  projectCode String?  // 工事番号
  client      String?  // 発注者
  location    String?  // 現場住所
  status      String   @default("active") // active, completed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workReports WorkReport[]
}

// 作業日報
model WorkReport {
  id                   String   @id @default(cuid())
  date                 DateTime // 作業日付
  userId               String   // 作成者（代表者）
  projectRefId         String?  // 物件マスタへの参照
  project              Project? @relation(fields: [projectRefId], references: [id])
  projectName          String   // 工事名（物件マスタから自動入力）
  projectType          String?  // 工事種別
  projectId            String?  // 工事番号
  weather              String?  // 天候
  contactNotes         String?  // 連絡事項
  remoteDepartureTime  String?  // 遠隔地出発時刻
  remoteArrivalTime    String?  // 現場着時刻
  remoteDepartureTime2 String?  // 現場発時刻
  remoteArrivalTime2   String?  // 会社着時刻
  trafficGuardCount    Int?     // 交通誘導警備員人数
  trafficGuardStart    String?  // 交通誘導警備員開始時刻
  trafficGuardEnd      String?  // 交通誘導警備員終了時刻
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  workerRecords        WorkerRecord[]
  materialRecords      MaterialRecord[]
  subcontractorRecords SubcontractorRecord[]
}

// 作業者記録
model WorkerRecord {
  id           String     @id @default(cuid())
  workReportId String
  workReport   WorkReport @relation(fields: [workReportId], references: [id], onDelete: Cascade)
  name         String     // 氏名
  startTime    String?    // 開始時刻 (HH:MM)
  endTime      String?    // 終了時刻 (HH:MM)
  workHours    Float?     // 工数
  workType     String?    // 工種
  details      String?    // 内訳
  dailyHours   Float?     // 当日工数
  totalHours   Float?     // 累計工数
  remainHours  Float?     // 手持ち工数
  order        Int        // 表示順序
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// 使用材料・消耗品記録
model MaterialRecord {
  id            String     @id @default(cuid())
  workReportId  String
  workReport    WorkReport @relation(fields: [workReportId], references: [id], onDelete: Cascade)
  name          String     // 材料名
  volume        String?    // 容量
  volumeUnit    String?    // 容量単位 (ℓ、mℓ、m、㎝)
  quantity      Float?     // 数量
  unitPrice     Float?     // 単価
  amount        Float?     // 金額 (数量 × 単価)
  subcontractor String?    // 外注先
  order         Int        // 表示順序
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

// 外注先記録
model SubcontractorRecord {
  id            String     @id @default(cuid())
  workReportId  String
  workReport    WorkReport @relation(fields: [workReportId], references: [id], onDelete: Cascade)
  name          String     // 外注先名
  workerCount   Int?       // 人数
  workContent   String?    // 作業内容
  order         Int        // 表示順序
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}
