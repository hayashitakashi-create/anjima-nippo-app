// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "sqlite"
  url       = env("DATABASE_URL")
}

// 社員マスタ
model User {
  id                String   @id @default(cuid())
  name              String
  username          String   @unique  // ログイン用ユーザー名
  password          String            // ハッシュ化されたパスワード
  position          String?           // 役職(社長、専務、常務、部長など)
  role              String   @default("user") // ユーザー権限 (admin/user)
  isActive          Boolean  @default(true)   // アカウント有効/無効
  defaultReportType String   @default("work") // デフォルト日報タイプ (sales: 営業日報, work: 作業日報)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  dailyReports  DailyReport[]
  approvals     Approval[]
  notifications Notification[]
}

// 日報
model DailyReport {
  id              String   @id @default(cuid())
  date            DateTime // 日報の日付
  userId          String   // 作成者
  user            User     @relation(fields: [userId], references: [id])
  specialNotes    String?  // 特記事項
  approvalRouteId String?  // 使用した承認ルート
  approvalRoute   ApprovalRoute? @relation(fields: [approvalRouteId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  visitRecords  VisitRecord[]
  approvals     Approval[]
}

// 訪問記録
model VisitRecord {
  id              String   @id @default(cuid())
  dailyReportId   String
  dailyReport     DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  destination     String   // 訪問先
  contactPerson   String?  // 面接者ご氏名
  startTime       String?  // 開始時刻 (HH:MM)
  endTime         String?  // 終了時刻 (HH:MM)
  content         String?  // 営業内容
  expense         Int?     // 支出経費
  order           Int      // 表示順序
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 承認ルート（承認フロー定義）
model ApprovalRoute {
  id          String   @id @default(cuid())
  name        String   // ルート名（例: 「社長決裁」「部長決裁」）
  roles       String   // JSON配列: 承認に含まれる役職リスト（例: '["社長","専務","常務","部長"]'）
  isDefault   Boolean  @default(false) // デフォルトルートかどうか
  order       Int      @default(0) // 表示順序
  isActive    Boolean  @default(true) // 有効/無効
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dailyReports DailyReport[]
}

// 承認
model Approval {
  id              String   @id @default(cuid())
  dailyReportId   String
  dailyReport     DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  approverRole    String   // 社長、専務、常務、部長
  approverUserId  String?  // 承認者
  approver        User?    @relation(fields: [approverUserId], references: [id])
  approvedAt      DateTime?
  status          String   @default("pending") // pending, approved, rejected
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 物件（現場）マスタ
model Project {
  id          String   @id @default(cuid())
  name        String   // 工事名
  projectType String?  // 工事種別
  projectCode String?  // 工事番号
  client      String?  // 発注者
  location    String?  // 現場住所
  status      String   @default("active") // active, completed, archived
  progress    Int      @default(0) // 進捗率 (0-100)
  startDate   DateTime? // 工期開始日
  endDate     DateTime? // 工期終了日
  notes       String?  // 備考
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workReports WorkReport[]
}

// 作業日報
model WorkReport {
  id                   String   @id @default(cuid())
  date                 DateTime // 作業日付
  userId               String   // 作成者（代表者）
  projectRefId         String?  // 物件マスタへの参照
  project              Project? @relation(fields: [projectRefId], references: [id])
  projectName          String   // 工事名（物件マスタから自動入力）
  projectType          String?  // 工事種別
  projectId            String?  // 工事番号
  weather              String?  // 天候
  contactNotes         String?  // 連絡事項
  remoteDepartureTime  String?  // 遠隔地出発時刻
  remoteArrivalTime    String?  // 現場着時刻
  remoteDepartureTime2 String?  // 現場発時刻
  remoteArrivalTime2   String?  // 会社着時刻
  trafficGuardCount    Int?     // 交通誘導警備員人数
  trafficGuardStart    String?  // 交通誘導警備員開始時刻
  trafficGuardEnd      String?  // 交通誘導警備員終了時刻
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  workerRecords        WorkerRecord[]
  materialRecords      MaterialRecord[]
  subcontractorRecords SubcontractorRecord[]
}

// 作業者記録
model WorkerRecord {
  id           String     @id @default(cuid())
  workReportId String
  workReport   WorkReport @relation(fields: [workReportId], references: [id], onDelete: Cascade)
  name         String     // 氏名
  startTime    String?    // 開始時刻 (HH:MM)
  endTime      String?    // 終了時刻 (HH:MM)
  workHours    Float?     // 工数
  workType     String?    // 工種
  details      String?    // 内訳
  dailyHours   Float?     // 当日工数
  totalHours   Float?     // 累計工数
  remainHours  Float?     // 手持ち工数
  order        Int        // 表示順序
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// 使用材料・消耗品記録
model MaterialRecord {
  id            String     @id @default(cuid())
  workReportId  String
  workReport    WorkReport @relation(fields: [workReportId], references: [id], onDelete: Cascade)
  name          String     // 材料名
  volume        String?    // 容量
  volumeUnit    String?    // 容量単位 (ℓ、mℓ、m、㎝)
  quantity      Float?     // 数量
  unitPrice     Float?     // 単価
  amount        Float?     // 金額 (数量 × 単価)
  subcontractor String?    // 外注先
  order         Int        // 表示順序
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

// 外注先記録
model SubcontractorRecord {
  id            String     @id @default(cuid())
  workReportId  String
  workReport    WorkReport @relation(fields: [workReportId], references: [id], onDelete: Cascade)
  name          String     // 外注先名
  workerCount   Int?       // 人数
  workContent   String?    // 作業内容
  order         Int        // 表示順序
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

// 操作ログ
model AuditLog {
  id         String   @id @default(cuid())
  userId     String   // 操作者
  action     String   // 操作種別 (user_created, user_updated, user_deleted, user_deactivated, project_created, etc.)
  targetType String   // 対象タイプ (user, project, nippo, work_report, system)
  targetId   String?  // 対象ID
  details    String?  // 操作詳細 (JSON文字列)
  ipAddress  String?  // IPアドレス
  createdAt  DateTime @default(now())
}

// システム設定
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique // 設定キー
  value     String   // 設定値 (JSON文字列)
  updatedAt DateTime @updatedAt
}

// 通知
model Notification {
  id        String   @id @default(cuid())
  userId    String   // 通知先ユーザー
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // report_submitted, report_approved, report_rejected, reminder
  title     String   // 通知タイトル
  message   String   // 通知メッセージ
  linkUrl   String?  // リンク先URL
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

// 使用材料マスタ
model Material {
  id            String   @id @default(cuid())
  name          String   // 材料名
  defaultVolume String?  // デフォルト容量（例: 20kg, 14kg）
  defaultUnit   String?  // デフォルト単位（ℓ、kg、m、本など）
  isActive      Boolean  @default(true) // 有効/無効
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// 外注先マスタ
model Subcontractor {
  id        String   @id @default(cuid())
  name      String   // 外注先名
  isActive  Boolean  @default(true) // 有効/無効
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 工事種別マスタ
model ProjectType {
  id        String   @id @default(cuid())
  name      String   // 工事種別名
  order     Int      @default(0) // 表示順序
  isActive  Boolean  @default(true) // 有効/無効
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
